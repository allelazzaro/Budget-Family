<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dettagli Differenze</title>

  <!-- Se li usi, li lasciamo: il nostro CSS sotto forza comunque la visibilità -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="fix_mobile_differenze.css">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

  <style>
    :root { --ink:#122; --line:#cfd6de; --card:#fff; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:#f3f6f9}
    .container{max-width:900px;margin:16px auto;padding:16px;background:var(--card);border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.08)}
    h1,h2,h3{margin:.2em 0 .4em}
    #periodoInfo{color:#456}

    /* Tabella: anti-tema, sempre visibile */
    #dettagliContainer{overflow-x:auto;-webkit-overflow-scrolling:touch; position:relative}
    #dettagliContainer table{display:table !important;border-collapse:collapse;min-width:800px;font-size:.9rem;background:#fff; position:relative; z-index:2}
    #dettagliContainer th,#dettagliContainer td{border:1px solid var(--line) !important;padding:6px 8px;text-align:center;color:#111 !important;background:#fff !important;white-space:nowrap}
    .detail-row td{background:#fafbfc !important}
    .sub-table{width:100%;border-collapse:collapse;margin:8px 0}
    .sub-table th,.sub-table td{border:1px solid var(--line);padding:8px;white-space:normal}

    .differenza-positiva{color:#0b7a22;font-weight:600}
    .differenza-negativa{color:#b00020;font-weight:600}

    #noDataMsg{margin-top:10px;color:#666}
    #diag{margin:12px 0;font:12px/1.3 system-ui;background:#ffffe3;border:1px solid #e6d86a;padding:8px;border-radius:8px;color:#5a5300}
    #diag strong{font-weight:700}

    /* Anti-tema globale dentro il container (se qualche foglio esterno nasconde) */
    #dettagliContainer, #dettagliContainer * { visibility: visible !important; opacity: 1 !important; }

    @media (max-width:480px){
      #dettagliContainer table{min-width:600px;font-size:.8rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="dettaglioTitle">Dettaglio Differenze</h1>
      <div id="periodoInfo"></div>
      <div id="diag" style="display:none"></div>
    </header>

    <section>
      <h2>Dettaglio per Categoria</h2>
      <div id="dettagliContainer"></div>
      <div id="noDataMsg" style="display:none">Nessun dato disponibile per il periodo selezionato.</div>
    </section>

    <footer style="margin-top:14px">
      <button onclick="tornaIndietro()">Torna Indietro</button>
    </footer>
  </div>

  <script>
    /* ----------------- Polyfill minimi per iOS vecchi ----------------- */
    if (!Object.values) {
      Object.values = function(obj){ return Object.keys(obj).map(function(k){ return obj[k]; }); };
    }
    if (!String.prototype.startsWith) {
      String.prototype.startsWith = function(search, pos){ pos = pos || 0; return this.substr(pos, search.length) === search; };
    }

    /* ---------------- Firebase ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyChK3rrqQ8hYygNLaahaxgtx8W1oUpxBP0",
      authDomain: "budget-a41a6.firebaseapp.com",
      databaseURL: "https://budget-a41a6-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "budget-a41a6",
      storageBucket: "budget-a41a6.appspot.com",
      messagingSenderId: "1044297998779",
      appId: "1:1044297998779:web:3848d0c0c2b9840b66249e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ---------------- Stato & util ---------------- */
    window.dettaglioData = {};
    const tipoDiff = localStorage.getItem('tipoDiff') || "";

    function toNumber(x){
      var n = parseFloat(String(x == null ? '' : x).replace(',', '.'));
      return isFinite(n) ? n : 0;
    }
    function formatCurrency(v){
      var n = toNumber(v);
      return n === 0 ? "" : "€" + n.toFixed(2);
    }
    function formatMonthYear(ym){
      if(!ym) return "";
      var p = ym.split('-');
      return p.length >= 2 ? (p[1] + "/" + p[0]) : ym;
    }

    // Supporta: "YYYY-MM", "YYYY-MM-DD", "DD/MM/YYYY"
    function parseDateKey(s){
      if(!s) return { y:null, ym:null };
      s = String(s).trim();
      var m = s.match(/^(\d{4})-(\d{2})(?:-(\d{2}))?$/);
      if(m) return { y:m[1], ym:(m[1]+"-"+m[2]) };
      m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(m) return { y:m[3], ym:(m[3]+"-"+m[2]) };
      m = s.match(/^(\d{4})/);
      if(m){
        var y=m[1], mm=s.slice(5,7);
        return { y:y, ym:/^\d{2}$/.test(mm)? (y+"-"+mm) : null };
      }
      return { y:null, ym:null };
    }

    function normTipo(val){
      var s = String(val || '').trim().toLowerCase();
      if (s.startsWith('entr')) return 'Entrata';
      if (s.startsWith('usc'))  return 'Uscita';
      return '';
    }
    function getCategoria(t){
      var cat = t.categoria || t.Categoria || t.descrizioneCategoria || t.DescrizioneCategoria ||
                t.descrizione || t.Descrizione || 'Sconosciuta';
      return String(cat);
    }

    function aggiornaTitolo(){
      var t = "Dettaglio Differenze";
      if (tipoDiff.indexOf("mese") === 0){
        var mc = localStorage.getItem('meseDiff');
        var pf = (tipoDiff==="meseGiulia")? " - Giulia" : (tipoDiff==="meseAlessio")? " - Alessio" : "";
        t = "Differenze Mese: " + formatMonthYear(mc) + pf;
      } else if (tipoDiff.indexOf("anno") === 0){
        var ac = localStorage.getItem('annoDiff');
        var pf2 = (tipoDiff==="annoGiulia")? " - Giulia" : (tipoDiff==="annoAlessio")? " - Alessio" : "";
        t = "Differenze Anno: " + ac + pf2;
      }
      document.getElementById('dettaglioTitle').textContent = t;
    }
    aggiornaTitolo();

    function showNoData(msg){
      var el = document.getElementById('noDataMsg');
      el.textContent = msg || "Nessun dato disponibile per questo periodo.";
      el.style.display = 'block';
    }
    function diag(obj){
      var d = document.getElementById('diag');
      var html = '';
      for (var k in obj){ if(obj.hasOwnProperty(k)){ html += '<div><strong>'+k+':</strong> '+obj[k]+'</div>'; } }
      d.innerHTML = html; d.style.display = 'block';
    }

    function scanStats(list){
      var tipi = {}; var senzaCat = 0;
      list.forEach(function(t){
        var tt = normTipo(t.tipo) || '(vuoto)';
        tipi[tt] = (tipi[tt]||0)+1;
        var cat = getCategoria(t);
        if(!cat || cat === 'Sconosciuta') senzaCat++;
      });
      var parts = []; for (var k in tipi){ if(tipi.hasOwnProperty(k)) parts.push(k+':'+tipi[k]); }
      return { tipiStr: parts.join(' | '), senzaCat: senzaCat };
    }

    /* -------- FALLBACK renderer in DIV (se la table viene nascosta) -------- */
    function renderFallbackList(rows, labels, personFilter, periodo){
      var html = '<div role="table" style="display:block">';
      html += '<div role="row" style="display:flex;font-weight:700;border-bottom:1px solid #cfd6de;padding:8px 6px">'
            + '<div style="flex:1 0 160px">Categoria</div>'
            + '<div style="width:120px;text-align:right">'+labels.eCurr+'</div>'
            + '<div style="width:120px;text-align:right">'+labels.ePrev+'</div>'
            + '<div style="width:120px;text-align:right">'+labels.uCurr+'</div>'
            + '<div style="width:120px;text-align:right">'+labels.uPrev+'</div>'
            + '<div style="width:120px;text-align:right">Saldo '+labels.sCurr+'</div>'
            + '<div style="width:120px;text-align:right">Saldo '+labels.sPrev+'</div>'
            + '<div style="width:120px;text-align:right">Diff</div>'
            + '</div>';

      rows.forEach(function(r){
        html += '<div role="row" class="category-row" data-category="'+r.cat+'" data-person="'+(personFilter||'')+'"'
              + ' onclick="toggleDetailRow(this,\''+periodo.kind+'\',\''+periodo.curr+'\',\''+periodo.prev+'\')"'
              + ' style="display:flex;border-bottom:1px solid #e6ebf1;padding:8px 6px">'
              +   '<div style="flex:1 0 160px">'+r.cat+'</div>'
              +   '<div style="width:120px;text-align:right">'+r.eCurr+'</div>'
              +   '<div style="width:120px;text-align:right">'+r.ePrev+'</div>'
              +   '<div style="width:120px;text-align:right">'+r.uCurr+'</div>'
              +   '<div style="width:120px;text-align:right">'+r.uPrev+'</div>'
              +   '<div style="width:120px;text-align:right">'+r.sCurr+'</div>'
              +   '<div style="width:120px;text-align:right">'+r.sPrev+'</div>'
              +   '<div style="width:120px;text-align:right" class="'+r.cls+'">'+r.diff+'</div>'
              + '</div>';
      });

      html += '</div>';
      return html;
    }

    /* ---------------- Costruzione tabelle ---------------- */
    function buildTable(listCurr, listPrev, labels, personFilter, periodo){
      var groupsCurr = {}, groupsPrev = {};

      var st1 = scanStats(listCurr);
      var st2 = scanStats(listPrev);

      listCurr.forEach(function(t){
        var cat = getCategoria(t);
        if(!groupsCurr[cat]) groupsCurr[cat] = { entrate:0, uscite:0 };
        var kind = normTipo(t.tipo);
        if (kind === 'Entrata') groupsCurr[cat].entrate += toNumber(t.importo);
        else if (kind === 'Uscita') groupsCurr[cat].uscite += toNumber(t.importo);
      });

      listPrev.forEach(function(t){
        var cat = getCategoria(t);
        if(!groupsPrev[cat]) groupsPrev[cat] = { entrate:0, uscite:0 };
        var kind = normTipo(t.tipo);
        if (kind === 'Entrata') groupsPrev[cat].entrate += toNumber(t.importo);
        else if (kind === 'Uscita') groupsPrev[cat].uscite += toNumber(t.importo);
      });

      var categories = [];
      var k;
      for (k in groupsCurr){ if(groupsCurr.hasOwnProperty(k)) categories.push(k); }
      for (k in groupsPrev){ if(groupsPrev.hasOwnProperty(k) && categories.indexOf(k)===-1) categories.push(k); }

      diag({
        OrigineDati: window._origin || 'Firebase',
        RecordTotali: Object.values(window.dettaglioData || {}).length,
        RecordPeriodoCorrente: listCurr.length,
        RecordPeriodoConfronto: listPrev.length,
        InfoFiltro: periodo.info,
        TipiPeriodoCorrente: st1.tipiStr,
        TipiPeriodoConfronto: st2.tipiStr,
        SenzaCategoriaCorrente: st1.senzaCat,
        SenzaCategoriaConfronto: st2.senzaCat
      });

      if (categories.length === 0){
        document.getElementById('dettagliContainer').innerHTML = "";
        showNoData();
        return;
      }

      categories.sort(function(a,b){
        if(a.toLowerCase()==='stipendio') return -1;
        if(b.toLowerCase()==='stipendio') return 1;
        if(a.toLowerCase()==='extra') return -1;
        if(b.toLowerCase()==='extra') return 1;
        var ua = groupsCurr[a] ? groupsCurr[a].uscite : 0;
        var ub = groupsCurr[b] ? groupsCurr[b].uscite : 0;
        return ub - ua;
      });

      /* Costruisco le righe in memoria */
      var rows = [];
      categories.forEach(function(cat){
        var curr = groupsCurr[cat] || { entrate:0, uscite:0 };
        var prev = groupsPrev[cat] || { entrate:0, uscite:0 };
        var saldoCurr = curr.entrate - curr.uscite;
        var saldoPrev = prev.entrate - prev.uscite;
        var diff = saldoCurr - saldoPrev;
        rows.push({
          cat: cat,
          eCurr: formatCurrency(curr.entrate),
          ePrev: formatCurrency(prev.entrate),
          uCurr: formatCurrency(curr.uscite),
          uPrev: formatCurrency(prev.uscite),
          sCurr: (saldoCurr===0 ? "" : "€"+saldoCurr.toFixed(2)),
          sPrev: (saldoPrev===0 ? "" : "€"+saldoPrev.toFixed(2)),
          diff:  (diff===0 ? "" : "€"+diff.toFixed(2)),
          cls:   (diff>=0 ? 'differenza-positiva' : 'differenza-negativa')
        });
      });

      /* Render tabellare standard */
      var html = '<table class="dettaglio-table"><thead><tr>'
        + '<th>Categoria</th>'
        + '<th>'+labels.eCurr+'</th>'
        + '<th>'+labels.ePrev+'</th>'
        + '<th>'+labels.uCurr+'</th>'
        + '<th>'+labels.uPrev+'</th>'
        + '<th>Saldo '+labels.sCurr+'</th>'
        + '<th>Saldo '+labels.sPrev+'</th>'
        + '<th>Diff Saldo</th>'
        + '</tr></thead><tbody>';

      rows.forEach(function(r){
        html += '<tr class="category-row" data-category="'+r.cat+'" data-person="'+(personFilter||'')+'"'
             +  ' onclick="toggleDetailRow(this,\''+periodo.kind+'\',\''+periodo.curr+'\',\''+periodo.prev+'\')">'
             +  '<td>'+r.cat+'</td>'
             +  '<td>'+r.eCurr+'</td>'
             +  '<td>'+r.ePrev+'</td>'
             +  '<td>'+r.uCurr+'</td>'
             +  '<td>'+r.uPrev+'</td>'
             +  '<td>'+r.sCurr+'</td>'
             +  '<td>'+r.sPrev+'</td>'
             +  '<td class="'+r.cls+'">'+r.diff+'</td>'
             +  '</tr>';
      });
      html += '</tbody></table>';

      var wrap = document.getElementById('dettagliContainer');
      wrap.innerHTML = html;
      document.getElementById('noDataMsg').style.display = 'none';

      /* FALLBACK: se la table è invisibile, rendo a DIV */
      setTimeout(function(){
        var tbl = wrap.querySelector('table');
        if (!tbl) return;
        var cs = window.getComputedStyle(tbl);
        var invisible = (tbl.offsetHeight === 0) ||
                        (cs.visibility === 'hidden') ||
                        (parseFloat(cs.opacity) === 0);
        if (invisible){
          wrap.innerHTML = renderFallbackList(rows, labels, personFilter, periodo);
        }
      }, 0);
    }

    function toggleDetailRow(row, kind, curr, prev){
      if (row.nextElementSibling && row.nextElementSibling.classList.contains('detail-row')){
        row.parentNode.removeChild(row.nextElementSibling);
        return;
      }
      var category = row.getAttribute('data-category');
      var person = row.getAttribute('data-person');
      var tx = Object.values(window.dettaglioData || {});

      function match(t, mode, key){
        var k = parseDateKey(t.data);
        return mode==='mese' ? (k.ym === key) : (k.y === key);
      }

      var listCurr = tx.filter(function(t){ return match(t,kind,curr) && getCategoria(t)===category && (!person || t.persona===person); });
      var listPrev = tx.filter(function(t){ return match(t,kind,prev) && getCategoria(t)===category && (!person || t.persona===person); });

      function sub(label, arr){
        if(!arr.length) return '<h3>'+label+'</h3><p>Nessun dettaglio per questo periodo.</p>';
        var s = '<h3>'+label+'</h3><table class="sub-table"><thead>' +
                '<tr><th>Data</th><th>Persona</th><th>Tipo</th><th>Importo</th><th>Descrizione</th></tr>' +
                '</thead><tbody>';
        arr.forEach(function(t){
          s += '<tr>' +
               '<td>'+(t.data||'')+'</td>' +
               '<td>'+(t.persona||'')+'</td>' +
               '<td>'+(normTipo(t.tipo) || (t.tipo||""))+'</td>' +
               '<td>'+formatCurrency(t.importo)+'</td>' +
               '<td>'+(t.descrizione||'')+'</td>' +
               '</tr>';
        });
        return s + '</tbody></table>';
      }

      var detail = '<div style="display:flex;flex-direction:column;gap:8px">' +
                   sub('Dettaglio '+category+' – '+(kind==='mese'?formatMonthYear(curr):curr), listCurr) +
                   sub('Dettaglio '+category+' – '+(kind==='mese'?formatMonthYear(prev):prev), listPrev) +
                   '</div>';

      /* Se ho reso a DIV (fallback), aggiungo il dettaglio come blocco sotto la riga cliccata */
      if (row.getAttribute('role') === 'row'){
        var detailDiv = document.createElement('div');
        detailDiv.className = 'detail-row';
        detailDiv.style.padding = '8px 6px';
        detailDiv.innerHTML = detail;
        row.parentNode.insertBefore(detailDiv, row.nextSibling);
        return;
      }

      /* Flusso table normale */
      var tr = document.createElement('tr'); tr.className = 'detail-row';
      var td = document.createElement('td'); td.colSpan = row.children.length; td.innerHTML = detail;
      tr.appendChild(td); row.parentNode.insertBefore(tr, row.nextElementSibling);
    }

    /* ---------------- Lettura + render ---------------- */
    function loadAndRender(){
      var meseCorrente   = localStorage.getItem('meseDiff');
      var meseConfronto  = localStorage.getItem('meseDiffPrev');
      var annoCorrente   = localStorage.getItem('annoDiff');
      var annoPrecedente = localStorage.getItem('annoDiffPrev');
      var personFilter = null;
      if (tipoDiff==="meseGiulia" || tipoDiff==="annoGiulia") personFilter = "Giulia";
      if (tipoDiff==="meseAlessio" || tipoDiff==="annoAlessio") personFilter = "Alessio";

      window._origin = 'Firebase';
      db.ref('transazioni').once('value').then(function(snap){
        var data = snap.val() || {};
        window.dettaglioData = data;

        var all = Object.values(data);
        var total = all.length;

        if (tipoDiff.indexOf("mese") === 0){
          document.getElementById('periodoInfo').innerHTML =
            '<h2>Mese: '+formatMonthYear(meseCorrente)+' vs '+formatMonthYear(meseConfronto)+'</h2>';

          var listCurr = all.filter(function(t){ return parseDateKey(t.data).ym===meseCorrente && (!personFilter || t.persona===personFilter); });
          var listPrev = all.filter(function(t){ return parseDateKey(t.data).ym===meseConfronto && (!personFilter || t.persona===personFilter); });

          // diagnosi macro
          diag({
            OrigineDati: window._origin,
            RecordTotali: total,
            RecordPeriodoCorrente: listCurr.length,
            RecordPeriodoConfronto: listPrev.length,
            InfoFiltro: 'tipoDiff='+tipoDiff+', meseCurr='+meseCorrente+', mesePrev='+meseConfronto+', persona='+(personFilter||'tutti')
          });

          buildTable(
            listCurr, listPrev,
            {
              eCurr:'Entrate ('+formatMonthYear(meseCorrente)+')',
              ePrev:'Entrate ('+formatMonthYear(meseConfronto)+')',
              uCurr:'Uscite ('+formatMonthYear(meseCorrente)+')',
              uPrev:'Uscite ('+formatMonthYear(meseConfronto)+')',
              sCurr:formatMonthYear(meseCorrente),
              sPrev:formatMonthYear(meseConfronto)
            },
            personFilter,
            { kind:'mese', curr:meseCorrente, prev:meseConfronto, info:'tipoDiff='+tipoDiff+', meseCurr='+meseCorrente+', mesePrev='+meseConfronto+', persona='+(personFilter||'tutti') }
          );

        } else if (tipoDiff.indexOf("anno") === 0){
          document.getElementById('periodoInfo').innerHTML =
            '<h2>Anno: '+annoCorrente+' vs '+annoPrecedente+'</h2>';

          var listCurrA = all.filter(function(t){ return parseDateKey(t.data).y===annoCorrente && (!personFilter || t.persona===personFilter); });
          var listPrevA = all.filter(function(t){ return parseDateKey(t.data).y===annoPrecedente && (!personFilter || t.persona===personFilter); });

          // diagnosi macro
          diag({
            OrigineDati: window._origin,
            RecordTotali: total,
            RecordPeriodoCorrente: listCurrA.length,
            RecordPeriodoConfronto: listPrevA.length,
            InfoFiltro: 'tipoDiff='+tipoDiff+', annoCurr='+annoCorrente+', annoPrev='+annoPrecedente+', persona='+(personFilter||'tutti')
          });

          buildTable(
            listCurrA, listPrevA,
            {
              eCurr:'Entrate ('+annoCorrente+')',
              ePrev:'Entrate ('+annoPrecedente+')',
              uCurr:'Uscite ('+annoCorrente+')',
              uPrev:'Uscite ('+annoPrecedente+')',
              sCurr:String(annoCorrente),
              sPrev:String(annoPrecedente)
            },
            personFilter,
            { kind:'anno', curr:annoCorrente, prev:annoPrecedente, info:'tipoDiff='+tipoDiff+', annoCurr='+annoCorrente+', annoPrev='+annoPrecedente+', persona='+(personFilter||'tutti') }
          );

        } else {
          document.getElementById('dettagliContainer').innerText = "Nessun dettaglio disponibile per questo tipo.";
          diag({ Nota:'tipoDiff non riconosciuto', tipoDiff: tipoDiff });
        }

        if (total === 0) showNoData("Nessun dato trovato su Firebase.");
      }).catch(function(e){
        console.error(e);
        showNoData("Errore nel caricamento dati.");
      });
    }

    loadAndRender();

    function tornaIndietro(){ window.location.href = "index.html"; }
  </script>
</body>
</html>
